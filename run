#!/bin/bash

set -e
set -u

lxc profile device set default eth0 mtu 9000

lxc profile create juju-default 2>/dev/null || echo "juju-default profile already exists"
lxc profile edit juju-default < lxd-profile.yaml

time juju bootstrap --config config.yaml localhost lxd

juju deploy bundle.yaml

# wait until nova-compute/0 becomes online
while ! juju ssh nova-compute/0 'true' 2>/dev/null; do
    sleep 5
done

juju ssh nova-compute/0 '

    # backport upstart job to avoid modprobe from inside container
    cat <<EOF | base64 -d | sudo tee /etc/init/nova-compute.override
IyB2aW06IHNldCBmdD11cHN0YXJ0IGV0IHRzPTI6CmRlc2NyaXB0aW9uICJOb3ZhIGNvbXB1dGUg
d29ya2VyIgphdXRob3IgIlNvcmVuIEhhbnNlbiA8c29yZW5AbGludXgyZ28uZGs+IgoKc3RhcnQg
b24gcnVubGV2ZWwgWzIzNDVdCnN0b3Agb24gcnVubGV2ZWwgWyEyMzQ1XQoKY2hkaXIgL3Zhci9y
dW4KCmVudiBNQVhfU1RBVFVTX0NIRUNLX1JFVFJJRVM9MjAKCnByZS1zdGFydCBzY3JpcHQKICBt
a2RpciAtcCAvdmFyL3J1bi9ub3ZhCiAgY2hvd24gbm92YTpyb290IC92YXIvcnVuL25vdmEvCgog
IG1rZGlyIC1wIC92YXIvbG9jay9ub3ZhCiAgY2hvd24gbm92YTpyb290IC92YXIvbG9jay9ub3Zh
LwoKICAjIE9ubHkgdHJ5IHRvIG1vZHByb2JlIGlmIG5vdCBydW5uaW5nIHdpdGhpbiBhIGNvbnRh
aW5lcgogIGlmIFsgISAtZiAvcnVuL2NvbnRhaW5lcl90eXBlIF07IHRoZW4KICAgIG1vZHByb2Jl
IG5iZAogIGZpCgogICMgSWYgbGlidmlydC1iaW4gaXMgaW5zdGFsbGVkLCBhbHdheXMgd2FpdCBm
b3IgaXQgdG8gc3RhcnQgZmlyc3QKICBpZiBzdGF0dXMgbGlidmlydC1iaW47IHRoZW4KICAgIHN0
YXJ0IHdhaXQtZm9yLXN0YXRlIFdBSVRfRk9SPWxpYnZpcnQtYmluIFdBSVRfU1RBVEU9cnVubmlu
ZyBXQUlURVI9bm92YS1jb21wdXRlCiAgZmkKCiAgIyBJZiBpbnN0YWxsZWQsIHdhaXQgZm9yIG5l
dXRyb24tb3ZzLWNsZWFudXAgdG8gY29tcGxldGUgcHJpb3IgdG8gc3RhcnRpbmcKICAjIG5vdmEt
Y29tcHV0ZS4KICBpZiBzdGF0dXMgbmV1dHJvbi1vdnMtY2xlYW51cDsgdGhlbgogICAgIyBTZWUg
TFAgIzE0NzEwMjIgZm9yIGV4cGxhbmF0aW9uIG9mIHdoeSB3ZSBkbyBsaWtlIHRoaXMKICAgIHJl
dHJpZXM9JE1BWF9TVEFUVVNfQ0hFQ0tfUkVUUklFUwogICAgZGVsYXk9MQogICAgd2hpbGUgdHJ1
ZTsgZG8KICAgICAgIyBBbHJlYWR5IHJ1bm5pbmc/CiAgICAgIHM9YHN0YXR1cyBuZXV0cm9uLW92
cy1jbGVhbnVwYAogICAgICBlY2hvICRzCiAgICAgIGBlY2hvICRzfCBncmVwIC1xRSAiXHNzdGFy
dC9ydW5uaW5nImAgJiYgYnJlYWsKICAgICAgaWYgcmV0cmllcz1gZXhwciAkcmV0cmllcyAtIDFg
OyB0aGVuCiAgICAgICAgIyBHaXZlIGl0IGEgcHVzaAogICAgICAgIGVjaG8gIkF0dGVtcHRpbmcg
dG8gc3RhcnQgbmV1dHJvbi1vdnMtY2xlYW51cCIKICAgICAgICBzdGFydCBuZXV0cm9uLW92cy1j
bGVhbnVwIHx8IDoKICAgICAgICAjIFdhaXQgYSBiaXQgdG8gYXZvaWQgaGFtbWVyaW5nIG92cy1j
bGVhbnVwICh3aGljaCBpdHNlbGYgbWF5IGJlIHdhaXRpbmcKICAgICAgICAjIG9uIGRlcGVuZGVu
Y2llcykKICAgICAgICBlY2hvICJSZWNoZWNrIG5ldXRyb24tb3ZzLWNsZWFudXAgc3RhdHVzIGlu
ICR7ZGVsYXl9cyIKICAgICAgICBzbGVlcCAkZGVsYXkKICAgICAgICBpZiBfPWBleHByICRyZXRy
aWVzICUgMmA7IHRoZW4KICAgICAgICAgICAgZGVsYXk9YGV4cHIgJGRlbGF5ICsgMmAKICAgICAg
ICBmaQogICAgICBlbHNlCiAgICAgICAgZWNobyAiTWF4IHJldHJpZXMgKCRNQVhfU1RBVFVTX0NI
RUNLX1JFVFJJRVMpIHJlYWNoZWQgLSBubyBsb25nZXIgd2FpdGluZyBmb3IgbmV1dHJvbi1vdnMt
Y2xlYW51cCB0byBzdGFydCIKICAgICAgICBicmVhawogICAgICBmaQogICAgZG9uZQogIGZpCmVu
ZCBzY3JpcHQKCmV4ZWMgc3RhcnQtc3RvcC1kYWVtb24gLS1zdGFydCAtLWNodWlkIG5vdmEgLS1l
eGVjIC91c3IvYmluL25vdmEtY29tcHV0ZSAtLSAtLWNvbmZpZy1maWxlPS9ldGMvbm92YS9ub3Zh
LmNvbmYgLS1jb25maWctZmlsZT0vZXRjL25vdmEvbm92YS1jb21wdXRlLmNvbmYK
EOF

    which nova-compute && sudo service nova-compute restart || true
' >/dev/null

watch_service=neutron-openvswitch
while juju status --format line "$watch_service" | grep -q "${watch_service}/.*:active"; do
    sleep 5
done
